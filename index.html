<!doctype html>
<html>

<head>
    <!-- update the version number as needed -->
    <!-- <script defer src="/__/firebase/5.3.1/firebase-app.js"></script> -->
    <!-- include only the Firebase features as you need -->
    <!-- <script defer src="/__/firebase/5.3.1/firebase-firestore.js"></script> -->
    <!-- <script defer src="/__/firebase/5.3.1/firebase-auth.js"></script> -->
    <!-- initialize the SDK after all desired features are loaded -->
    <!-- <script defer src="/__/firebase/init.js"></script> -->

    <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <!-- <link rel="import" href="tt-rule-editor.html"> -->
    <link rel="import" href="gin-app.html">
    <link rel="import" href="gin-auth.html">
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,700" rel="stylesheet">
    <style is="custom-style">
        * {
            box-sizing: border-box;
            font-family: 'Nunito', sans-serif;
            user-select: none;
        }

        body {
            margin: 0;
        }

        iron-overlay-backdrop {
            --iron-overlay-backdrop-opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <gin-app id="app" on-open-auth="openAuth"></gin-app>
    <gin-auth id="auth"></gin-auth>
    <script>
        var setup;
        var db;
        document.addEventListener('DOMContentLoaded', function () {
            if (setup) {
                return;
            }
            console.log('event listener added')
            document.documentElement.addEventListener('open-auth', openAuth);
            document.documentElement.addEventListener('firebase-request', e => {
                if (e.detail.type === 'signup') {
                    console.log('firebase received in index');
                    firebase.auth().createUserWithEmailAndPassword(e.detail.email, e.detail.password)
                        .then((res) => {
                            console.log('signed up ID', res.user.email);
                            db.collection('users').doc(res.user.email).set({
                                email: res.user.email,
                                gins: []
                            })
                                .then(function () {
                                    console.log("User written successfuly");
                                })
                                .catch(function (error) {
                                    console.error("Error adding user: ", error);
                                });
                        })
                        .catch(function (error) {
                            // Handle Errors here.
                            var errorCode = error.code;
                            var errorMessage = error.message;
                            // ...
                        });

                } else if (e.detail.type === 'login') {
                    console.log('gin login', e.detail.email, e.detail.password);
                    firebase.auth().signInWithEmailAndPassword(e.detail.email, e.detail.password)
                        .catch(function (error) {
                            // Handle Errors here.
                            var errorCode = error.code;
                            var errorMessage = error.message;
                        });
                } else if (e.detail.type === 'signout') {
                    firebase.auth().signOut().then(() => {
                        console.log('Signed Out');
                         document.getElementById('app').set('user', null);
                         document.getElementById('app').set('rules', []);

                    }, function (error) {
                        console.error('Sign Out Error', error);
                    });
                }  else if (e.detail.type === 'deleteGin') {
                    console.log('delete gin with index:', e.detail.ginIndex);
                } else if (e.detail.type === 'editGin') {

                } else if (e.detail.type === 'create-gin') {
                    let docReference = db.collection('gins').doc();
                    const user = document.getElementById('app').user;
                    console.log('adding a gin', docReference.id);
                    docReference.set(Object.assign({ timestamp: firebase.firestore.FieldValue.serverTimestamp(), members: [user.uid] }, e.detail.gin))
                        .then(function (docRef) {
                            console.log('Success adding document', docRef);
                               
                        })
                        .catch(function (error) {
                            console.error('Error adding document: ', error);
                        });
                } else if (e.detail.type === 'edit-gin') {
                    db.collection('gins').doc(e.detail.docId). update({
                        'title': e.detail.title,
                        'actions': e.detail.newState.actions
                    })
                        .then(function () {
                            console.log("Document successfully updated!");
                        });

                }
            })
            try {
                // Initialize Firebase
                var config = {
                    apiKey: "AIzaSyD-qcQxFOyM4wand0BMEYmeuqlEdXk_gpc",
                    authDomain: "gin-app.firebaseapp.com",
                    databaseURL: "https://gin-app.firebaseio.com",
                    projectId: "gin-app",
                    storageBucket: "gin-app.appspot.com",
                    messagingSenderId: "835112964662"
                };
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }

                // Initialize Cloud Firestore through Firebase
                db = firebase.firestore();
                const settings = { timestampsInSnapshots: true };
                db.settings(settings);

            } catch (e) {
                console.error(e);
                // Set dummy data for development if firebase fails
                // return;
                document.getElementById('app').set('rules', [
                    {
                        title: 'Alpha rule 1',
                        id: 1,
                        section: 'actions',
                        actions: [
                            {
                                type: 'Add columns',
                                columns: [
                                    {
                                        label: 'John',
                                        defaultSegments: [{
                                            label: 'value',
                                            tableValue: true
                                        },
                                        {
                                            label: '*'
                                        },
                                        {
                                            label: '0.5'
                                        }
                                        ],
                                        plots: [
                                            {
                                                conditions: [{ "x": { "label": "type", "type": "string", "val": "notSet", "tableValue": true }, "operator": { "label": "is" }, "y": "bond" }],
                                                segments: [
                                                    {
                                                        label: 'value',
                                                        tableValue: true
                                                    },
                                                    {
                                                        label: '*'
                                                    },
                                                    {
                                                        label: '0.8'
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        label: 'Paul',
                                        defaultSegments: [
                                            {
                                                label: 'value',
                                                tableValue: true
                                            },
                                            {
                                                label: '*'
                                            },
                                            {
                                                label: '1'
                                            }
                                        ],
                                    }
                                ]
                            }
                        ],
                        columnVariables: [{
                            label: 'type',
                            type: 'string',
                            tableValue: true
                        }, {
                            label: 'value',
                            type: 'number',
                            tableValue: true
                        }]
                    }, {
                        title: 'Beta rule 2',
                        id: 2,
                        section: 'actions',
                        columnVariables: [{
                            label: 'type',
                            type: 'string',
                            tableValue: true
                        }, {
                            label: 'value',
                            type: 'number',
                            tableValue: true
                        }]
                    }, {
                        title: 'Charlie rule 3',
                        id: 3,
                        section: 'actions',
                        columnVariables: [{
                            label: 'type',
                            type: 'string',
                            tableValue: true
                        }, {
                            label: 'value',
                            type: 'number',
                            tableValue: true
                        }]
                    }
                ])

            }
            function settingGins(ginReferences) {
                ginReferences.forEach(ginReference => {
                    var ginRef = db.collection('gins').doc(ginReference);
                    ginRef.get()
                        .then(function (gin) {
                            if (gin.exists) {
                                console.log('User data:', user.data());
                                userRef.get()
                                    .then(function (user) {
                                        if (user.exists) {
                                            console.log('User data:', user.data());
    
                                        } else {
                                            // doc.data() will be undefined in this case
                                            console.log('No such user!');
                                        }
                                    }).catch(function (error) {
                                        console.log('Error getting user:', error);
                                    });
                            } else {
                                // doc.data() will be undefined in this case
                                console.log('No such user!');
                            }
                        });
                });
            }
            function openAuth () {
                console.log('open auth index')
                document.getElementById('auth').open();
            }
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    console.log('user', user);
                    document.getElementById('auth').close();
                    document.getElementById('app').set('user', user);
                    db.collection('gins').where('members', 'array-contains', user.uid)
                        .get()
                        .then(function (querySnapshot) {
                            const tempArray = [];
                            querySnapshot.forEach(function (doc) {
                                // doc.data() is never undefined for query doc snapshots
                                console.log(doc.id, " => ", doc.data());
                                tempArray.push(Object.assign({id: doc.id}, doc.data()));
                            });
                            document.getElementById('app').set('rules', tempArray);
                        })
                        .catch(function (error) {
                            console.log("Error getting documents: ", error);
                        });
                    // User is signed in.
                } else {
                    console.log('no user');
                    //TODO: set error
                    // document.getElementById('auth').setError();
                    // No user is signed in.
                }
            });
            setup = true;
        });
    </script>
</body>

</html>