<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="gin-rule-editor.html">
<link rel="import" href="gin-icons.html">
<link rel="import" href="gin-shared-styles.html">
<script src="papaparse.min.js"></script>

<dom-module id="gin-rule-list">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment gin-shared-styles">
      :host {
        display: block;
        padding-bottom: 400px;
      }
      #top-bar {
        margin: 56px 0 80px;
      }
      #search-field iron-icon {
        --iron-icon-fill-color: var(--gin-grey-100);
        margin: 0 0 1px 4px;
        transition: 200ms fill;
      }
      #search-field:hover iron-icon {
        --iron-icon-fill-color: var(--gin-grey-300);
      }
      #search-field:hover input {
        border-color: var(--gin-grey-200);
        --iron-icon-fill-color: var(--gin-grey-300);
      }
      gin-rule-editor {
        width: 100%;
        box-sizing: border-box;
        margin: 0 auto;
      }
      #side-action-container {
        position: absolute;
        top: 0;
        right: 0px;
        border-radius: 5px;
      }
      #side-action-container iron-icon {
        --iron-icon-width: 28px;
        --iron-icon-height: 28px;
        margin-right: 8px;
        transition: transform 250ms;
      }
      :host([new-mode]) #side-action-container iron-icon {
        transform: rotate(-45deg);
      }
      input {
        font-size: 16px;
        border: none;
        padding: 4px 1px;
        border-bottom: 1px solid var(--gin-grey-100);
        transition: 200ms border-color;
      }
      input:focus {
        outline: none;
        border-color: var(--gin-grey-200);
      }

      gin-rule-editor {
        margin: 0 auto 40px;
      }

      #new-form {
        border: 1px dashed var(--gin-grey-100);
        color: var(--gin-grey-300);
        transition: border-color 250ms, color 250ms;
        padding: 32px;
        margin: 0 auto 40px;
      }
      #new-form input {
        margin-right: 32px;
      }

      #rule-list {
        max-width: 680px;
        width: 100%;
        margin: 0 auto;
      }

      [hidden] {
        display: none !important;
      }
    </style>
    <div id="rule-list">
      <!-- Top bar -->
      <div id="top-bar" class="horizontal layout center-center l-relative">
        <div id="search-field" on-click="focusSearch" class="horizontal layout center-center">
          <input type="text" value="{{searchString::input}}" placeholder="Search">
          <iron-icon icon="gin-icons:search"></iron-icon>
        </div>
        <div id="side-action-container" class="horizontal layout center-center">
          <iron-icon icon="gin-icons:add" class="hoverable" on-click="toggleNewMode"></iron-icon>
        </div>
      </div>
      <!-- New form -->
      <div id="new-form" class="horizontal layout center-center" hidden$="[[!newMode]]">
        <div class="flex">
          <input type="text" size="35" placeholder="New title">
        </div>
        <div class="horizontal layout center-center">
          <button class="simple" on-click="addRule">
            <div>Submit</div>
          </button>
        </div>
      </div>
      <!-- Gins -->
      <template is="dom-repeat" id="repeater" items="{{rules}}" as="rule" index-as="ruleIndex" filter="[[_computeFilter(searchString)]]">
        <gin-rule-editor actions="{{rule.actions}}" title="{{rule.title}}" on-delete-request="deleteGin"
          column-variables="[[_computeColumnVariables(rule, rule.columnVariables)]]"></gin-rule-editor>
      </template>
    </div>
  </template>
  <script>
    class ginRuleList extends Polymer.Element {
      static get is() { return 'gin-rule-list'; }
      static get properties() {
        return {
          selected: {
            type: Number,
            value: 0
          },
          rules: {
            type: Array,
            value: () => [],
            notify: true
          },
          searchString: {
            type: String,
            value: null
          },
          newMode: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          }
        }
      }
      constructor() {
        super();
      }
      static get observers() {
        return [
        ];
      }
      _computeFilter(searchString) {
        if (!searchString) {
          // set filter to null to disable filtering
          return null;
        } else {
          // return a filter function for the current search string
          searchString = searchString.toLowerCase();
          return function (item) {
            const regex = new RegExp(searchString, 'i');
            return regex.test(item.title);
          };
        }
      }
      _computeColumnVariables(rule, columnVariables) {
        return columnVariables || [];
      }
      delete(index) {
        this.splice('rules', index, 1);
      }
      focusSearch(e) {
        e.stopPropagation();
        this.shadowRoot.querySelector('input').focus();
      }
      // renderRepeater() {
      //   console.log('lol');
      //   this.$.repeater.render();
      // }
      deleteGin(e) {
        console.log(e.model)
        const cacheRules = this.rules;
        this.set('rules', []);

        // this.notifyPath('rules');
        setTimeout(() => {
          this.set('rules', cacheRules.filter((rule, index) => index !== e.model.ruleIndex));
          this.dispatchEvent(
            new CustomEvent('firebase-request', {
              bubbles: true,
              composed: true,
              detail: {
                type: 'deleteGin',
                ginIndex: e.model.ruleIndex
              }
            })
          );
          this.$.repeater.render()
        });
      }
      toggleNewMode() {
        this.newMode = !this.newMode;
      }
      addRule() {
        const newGin = {
          title: this.shadowRoot.querySelector('#new-form input').value,
          actions: []
        };
        this.unshift('rules', newGin);
        console.log('dispatching create gin')
        this.dispatchEvent(
          new CustomEvent('firebase-request', {
            bubbles: true,
            composed: true,
            detail: {
              type: 'create-gin',
              gin: newGin
            }
          })
        );
        this.closeNewForm();
      }
      closeNewForm() {
        this.newMode = false;
        this.shadowRoot.querySelector('#new-form input').value = null;
      }
    }
    customElements.define(ginRuleList.is, ginRuleList);
  </script>
</dom-module>