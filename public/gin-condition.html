<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="gin-dialog.html">
<link rel="import" href="gin-shared-styles.html">

<dom-module id="gin-condition">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment gin-shared-styles">
      :host {
        display: block;
      }

      input {
        border: none;
        font-size: 14px;
      }

      .key {
        width: 104px;
        margin: 8px 16px;
        padding: 4px 0;
        border-bottom: 1px solid var(--gin-grey-100);
        height: 24px;
      }

      .key:focus {
        outline: none;
      }

      #dialog-container {
        position: relative;
      }

      [hidden] {
        display: none !important;
      }
    </style>
    <div class="horizontal layout center-center">
      <div class="key" data-label="x" on-click="openOptions">[[x.label]]</div>
      <div class="key" data-label="operator" on-click="openOptions" hidden$="[[!withTableValue]]">[[operator.label]]</div>

      <input type$="[[x.type]]" class="key" value="{{y::change}}" on-change="blurInput" hidden$="[[!withTableValue]]">
    </div>
    <gin-dialog id="dialog" on-val-changed="onValChanged" on-new-option-request="_onNewOptionRequest" with-text-input></gin-dialog>
  </template>
  <script>
    class GinCondition extends Polymer.Element {
      static get is() { return 'gin-condition'; }
      static get properties() {
        return {
          editedProperty: {
            type: String
          },
          flag: {
            type: Boolean,
            value: false
          },
          withTableValue: {
            type: Boolean,
            value: false
          },
          x: {
            type: Object,
            value: () => {
              return {
                label: ''
              }
            },
            notify: true
          },
          xOptions: {
            type: Array,
            value: () => []
          },
          yLabel: {
            type: String,
            notify: true
          },
          y: {
            type: Object,
            notify: true
          },
          operatorOptionLibrary: {
            type: Object,
            value: () => {
              return {
                string: [{
                  label: 'is'
                }, {
                  label: 'isn\'t'
                }],
                number: [{
                  label: 'smaller'
                }, {
                  label: 'greater'
                }],
                date: [{
                  label: 'on'
                }, {
                  label: 'before'
                }, {
                  label: 'after'
                }]
              };
            }
          },
          operatorOptions: {
            type: Array,
            computed: 'computeOperatorOptions(x, withTableValue)'
          },
          operator: {
            type: Object,
            value: () => {
              return {
                label: 'is'
              };
            },
            notify: true
          },
          columnVariables: {
            type: Array,
            value: () => [],
            notify: true
          }
        }
      }
      static get observers() {
        return [
          'onXChanged(x.*)'
        ];
      }
      constructor() {
        super();
      }
      blurInput(e) {
        e.target.blur();
      }
      onValChanged(e) {
        this.set(`${this.editedProperty}`, e.detail.value);
        this.notifyPath(`${this.editedProperty}`);
      }
      onXChanged() {
        this.withTableValue = (this.x && this.x.tableValue) || false;
      }
      run() {
        // console.log(this.x.val, this.operator.label, this.y.val);
        if (typeof this.operator.label === 'undefined',
          typeof this.x.val === 'undefined',
          typeof this.y.val === 'undefined') {
          return;
        }
        const x = this.x.val;
        const y = this.y.val;
        switch (this.operator.label) {
          case 'is':
            return x === y;
            break;
          case 'isn\'t':
            return x !== y;
            break;
          case 'smaller':
            return x < y;
            break;
          case 'greater':
            return x > y;
            break;
          default:
            return false;
        }
      }
      computeOperatorOptions(x) {
        if (!this.withTableValue) {
          return;
        }
        return this.operatorOptionLibrary[x.type];
      }
      openOptions(e) {
        this.editedProperty = e.target.getAttribute('data-label');
        const options = this[`${this.editedProperty}Options`];
        this.$.dialog.openOptions(e.target, options);
      }
      _onNewOptionRequest(e) {
        this.unshift('columnVariables', e.detail);
      }
    }
    customElements.define(GinCondition.is, GinCondition);
  </script>
</dom-module>