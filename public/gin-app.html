<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="gin-rule-list.html">
<link rel="import" href="gin-icons.html">
<link rel="import" href="gin-shared-styles.html">

<dom-module id="gin-app">

    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment gin-shared-styles">
            :host {
                display: block;
            }
            nav {
                opacity: 1;
                display: flex;
                flex-direction: row;
                padding: 16px 24px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.09);
            }
            nav>.action-menu {
                margin-left: 32px;
                font-size: 14px;
            }
            nav>.action-menu>#nav-btn {
                padding: 8px 16px;
                border-radius: 3px;
                cursor: pointer;
                transition: background 0.3s;
            }
            nav>.action-menu>#nav-btn:hover {
                outline: 0;
            }
            nav>.brand {
                font-size: 28px;
                letter-spacing: 3.8px;
                color: #212121;
                border-radius: 5px;
            }
            #nav-btn {
                color: var(--gin-grey-200);
                transition: color 250ms;
            }
            #nav-btn:hover {
                color: var(--gin-grey-500);
            }
            .dialog-content {
                margin: 0;
            }
            iron-icon {
                --iron-icon-fill-color: #212121;
            }
            [hidden] {
                display: none !important;
            }
        </style>

        <nav class="horizontal layout">
            <div class="brand">GIN</div>
            <div class="action-menu horizontal layout center end-justified flex">
                <!-- <div id="nav-btn" on-click="openSideMenu">
                    <iron-icon icon="gin-icons:menu"></iron-icon>
                </div> -->
                <div id="nav-btn" on-click="openAuth" hidden$="[[user]]">
                    <div>Login</div>
                </div>
                <div hidden$="[[!user]]">[[user.email]]</div>
                <div id="nav-btn" on-click="signOut" hidden$="[[!user]]">
                    <div>Sign out</div>
                </div>
            </div>
        </nav>

        <iron-pages id="pager" attr-for-selected="data-route" selected="[[section]]">
            <gin-rule-list rules="{{rules}}" data-route="units"></gin-rule-list>
            <gin-settings data-route="settings"></gin-settings>
        </iron-pages>
        <paper-dialog id="dialog" no-cancel-on-outside-click with-backdrop>
            <div id="dialog-content" class="no-padding">
                <input id="email-input" on-keyup="onKeyup" type="text">
                <input id="email-input" on-keyup="onKeyup" type="text">
            </div>
        </paper-dialog>
        <paper-dialog id="side-menu" class="side-menu" vertical-align="top" horizontal-align="right"
            on-iron-overlay-closed="removeScrollListener">
            <div class="dialog-content no-padding">
                <div class="side-menu-container">
                    <!-- <div class="horizontal layout">
                            <iron-icon icon="gin-icons:content-copy"></iron-icon>
                            <div>Copy</div>
                          </div> -->
                    <div class="horizontal layout" on-click="deleteAction">
                        <iron-icon icon="gin-icons:delete"></iron-icon>
                        <div>Delete</div>
                    </div>
                </div>
            </div>
        </paper-dialog>

    </template>
    <script>

        class GinApp extends Polymer.Element {
            static get is() { return 'gin-app'; }
            static get properties() {
                return {
                    section: {
                        type: String,
                        value: 'units'
                    },
                    user: {
                        type: Object,
                        value: null,
                        observer: 'onUserChanged'
                    },
                    rules: {
                        type: Array,
                        value: () => []
                    }
                }
            }
            static get observers() {
                return [
                    'onRulesChanged(rules.*, rules)'
                ];
            }
            constructor() {
                super();
                this.onFireBaseCall = this.onFireBaseCall.bind(this);
                this.addEventListener('firebase-request', this.onFireBaseCall);
            }
            onRulesChanged(e) {
                console.log('Save', e.path);
                if (/actions|title/.test(e.path)) {
                    console.log('Firebase EDIT', e.path);
                    e.path.replace(/(rules.)(\d+)/, (match, firstGroup, secondGroup) => {
                        const ruleIndex = secondGroup;
                        console.log('ruleIndex', ruleIndex);
                        // different logic for splice, push etc.
                        this.dispatchEvent(
                            new CustomEvent('firebase-request', {
                                bubbles: true,
                                composed: true,
                                detail: {
                                    type: 'edit-gin',
                                    title: this.rules[ruleIndex].title,
                                    docId: this.rules[ruleIndex].id,
                                    newState: this.rules[ruleIndex]
                                }
                            })
                        );
                    });
                }
            }
            signOut() {
                this.dispatchEvent(
                    new CustomEvent('firebase-request', {
                        bubbles: true,
                        composed: true,
                        detail: {
                            type: 'signout'
                        }
                    })
                );
            }
            selectSection(e) {
                this.section = e.composedPath()[0].getAttribute('data-section');
            }
            openSideMenu() {
                this.shadowRoot.querySelector('#side-menu').set('positionTarget', this.shadowRoot.querySelector('#nav-btn'));
                this.shadowRoot.querySelector('#side-menu').open();
            }
            openAuth(e) {
                e.stopPropagation();
                this.dispatchEvent(
                    new CustomEvent('open-auth', {
                        bubbles: true,
                        composed: true,
                    })
                );
            }
            onFireBaseCall(e) {
                console.log('firebase called', e);
            }
            onUserChanged(user) {
                console.log('user', user);
            }
        }
        customElements.define(GinApp.is, GinApp);
    </script>
</dom-module>